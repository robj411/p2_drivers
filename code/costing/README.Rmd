---
title: "The Costing Model"
#date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::github_document2:
    # pandoc_args: --webtex
    toc: true
    toc_depth: 5
    toc_float: true
    number_sections: true
  bookdown::pdf_document2: 
    #   --filter=pandoc-xnos
    toc: false
    keep_tex: yes
    citation_package: natbib
    extra_dependencies: ["float"]
    # extra_dependencies: ["flafter"]
    # pandoc_args:
    number_sections: true
    fig_caption: yes
    # includes:
    #   in_header: "preamble.tex"
  bookdown::word_document2: 
    toc_depth: 5
    toc_float: true
    number_sections: true
    editor_options: 
      chunk_output_type: inline
bibliography: 
  - "../../epi.bib"
always_allow_html: true
---





<!-- # Figures (temporary) {.unlisted .unnumbered} -->

```{r setup, include=FALSE}
library(ggplot2)  
library(knitr)     
library(tidyr)
library(dplyr)
library(stringi)
library(gplots)
library(RColorBrewer)
library(data.table)
library(splines)
library(bookdown)
library(pander)
library(haven)
library(viridis)
library(hrbrthemes)
library(MASS)
library(kableExtra)
library(wbstats)
library("cowplot")
library(latex2exp)
library(statmod)
library(TruncExpFam)
library(EnvStats)
library(extraDistr)
library(PearsonDS)
library(ggpubr)

source('functions.R')

panderOptions('round',2)
panderOptions('table.split.table', Inf)

knitr::opts_chunk$set(comment=NA, prompt=FALSE, cache=FALSE, echo=F, message=F, warning=F, results='asis')

format_to_print <- function(x,z=-1){
  formatC(round(x,z), format="f", digits=as.numeric(z>0), big.mark=",")
}

decimalplaces <- function(x) {
    if ((x %% 1) != 0) {
        nchar(strsplit(sub('0+$', '', as.character(format(x,scientific = F))), ".", fixed=TRUE)[[1]][[2]])
    } else {
        return(0)
    }
}

format_to_print2 <- function(x,z=2){
    v <- signif(x,z)
    sapply(v, function(i)  formatC(i, format="f", digits=decimalplaces(i), big.mark=","))
}

```

```{r ages, eval=FALSE}

# age data from owid
allpop = read.csv('population-by-five-year-age-group.csv')
ils = unique(allpop$Entity)[grepl('-income',unique(allpop$Entity))]
maxyear = max(allpop$Year)
ildata = subset(allpop,Entity%in%ils&Year==maxyear)
popcols = which(grepl('Population',colnames(ildata)))
col14 = which(grepl('14',colnames(ildata)))
col64 = which(grepl('64',colnames(ildata)))
for(i in 1:nrow(ildata)){
  print(ildata$Entity[i])
  print(sum(as.numeric(ildata[i,popcols])))
  print(sum(as.numeric(ildata[i,popcols[popcols>col14]])))
  print(sum(as.numeric(ildata[i,popcols[popcols>col64]])))
}

```





This document describes the costing model that is used in the CEPI application. 



# Parameters

```{r paramtable, echo=F,warning=F,message=F}

caps <- readODS::read_ods('cost_parameters.ods',sheet = 1)
caps$`Math notation` <- paste0('$',caps$`Math notation`,'$')
lg <- 'Notation and parametric assumptions for inputs to the costing model. Parameters are used as follows: uniform distributions go from Parameter 1 to Parameter 2. Triangular distributions go from Parameter 1 to Parameter 3 with a peak at Parameter 2. Multinomial distributions have equally probable values listed individually. Exponential distributions have as a mean Parameter 1. Inverse Gaussian distributions have as a mean Parameter 1, and as a shape Parameter 2. Log normal distributions have as a mean Parameter 1, and as a standard deviation Parameter 2. PearsonV distributions have shape Parameter 1, scale Parameter 2, and location 0. PearsonVI distributions have shape Parameters 1 and 2, scale Parameter 3, and location 0. Where given, distributions are truncated at bounds.'
capscopy = caps
if (knitr::is_html_output()) {
  capscopy$Source <- gsub('}','',capscopy$Source)
  capscopy$Source <- gsub('\\\\citet\\{','@',capscopy$Source)
} else {
  capscopy$Code <- NULL
}
cat(pander(capscopy,caption=lg, missing = ""))

```


```{r sample}

## parameter samples  ######################################################

plist <- get_parameters(nsamples=10)

params <- plist[[2]]
rawpar <- plist[[1]]

# pardf = as.data.frame(do.call(cbind,rawpar))


```


```{r}

## model variables ######################################################

# weeks_init = sapply(MAN_TYPES,function(x)rawpar[[paste0('weeks_init_',x)]])
# weeks_scale = sapply(MAN_TYPES,function(x)rawpar[[paste0('weeks_scale_',x)]])


# ics = c('hic','umic','lmic','lic')
crs= c(0, 0.7, 2)

## populations and vaccine demand

# pops = sapply(paste0('pop_',ics,'_0'),function(x)rawpar[[x]])
# pops0 = pops[1:3]
# pops0[3] = sum(pops[3:4])
# 
# pops = sapply(paste0('pop_',ics,'_15'),function(x)rawpar[[x]])
# pops3 = pops[1:3]
# pops3[3] = sum(pops[3:4])
# 
# pops65 = sapply(paste0('pop_',ics,'_65'),function(x)rawpar[[x]])
# pops365 = pops65[1:3]
# pops365[3] = sum(pops65[3:4])
# 
# demand65 = rawpar$final_vaccine_coverage*pops365 / (1-rawpar$vaccine_wastage) # total bpsv doses per income level
# popfracs65 = pops365/sum(pops365)
# total_bpsv_demand = 1 # billion. not: sum(demand65/1e9)
# 
# DEMAND15 = rawpar$final_vaccine_coverage*pops3*2 / (1-rawpar$vaccine_wastage)
# popfracs15 = pops3/sum(pops3)
# # two doses plus two boosters
# max_demand = sum(DEMAND15)*2

basic_rates = c(.07, .07, .02, .02)



fifteen_yr_discount_weight = sapply(1:NSAMPLES, function(x) accumulate(discount = pardf$discount[x], from = 1, to = pardf$years_100[x]))
five_yr_discount_weight = sapply(1:NSAMPLES, function(x) accumulate(discount = pardf$discount[x], from = 1, to = pardf$years_200[x]))
at_yr_15 = sapply(1:NSAMPLES, function(x) accumulate(discount = pardf$discount[x], from = pardf$years_100[x]+1, to = pardf$years_100[x]+1))
at_yr_6 = sapply(1:NSAMPLES, function(x) accumulate(discount = pardf$discount[x], from = pardf$years_200[x]+1, to = pardf$years_200[x]+1))

## enabling costs
# matches order of dms
dm_rd_times = c(0, rawpar$years_200, rawpar$years_100)
get_enabling_costs = function(cost_enab, discount=0, target_dm = 365){
  rd_years = dm_rd_times[which(dms==target_dm)]
  cost_enab * accumulate(discount, from=1, to=rd_years)
}

enabling_costs_list = list()
for(x in 1:length(dms)){
  enabling_costs_list[[x]] <- rep(0,NSAMPLES)
  for(i in 1:NSAMPLES){
    enabling_costs_list[[x]][i] = get_enabling_costs(pardf$cost_enab[i], pardf$discount[i], target_dm = dms[x])
  }
}

```


```{r}

## trial timings

get_phase_durations = function(dm=365){
  # phase durations depend on prior R&D investments
  # there are four phases 
  # there are three options for dm: 365, 200 and 100
  phase_duration = rep(0,4)
  for(i in 0:3){
    pars = paste0('weeks_P',i,'_',dm)
    phase_duration[i+1] = rawpar[[pars]]
  }
  phase_duration
}

phase_duration = matrix(0,length(dms),4)
for(j in 1:length(dms)){
  phase_duration[j,] = get_phase_durations(dms[j])
}

# trial durations in normal times
old_durations = do.call(cbind,lapply(paste0('duration_',0:3),function(x)52*rawpar[[x]]))


timescale = list()
for(j in 1:length(dms)){
  timescale[[j]] = matrix(0,NSAMPLES,4)
  for(i in 1:NSAMPLES) {
    timescale[[j]][i,] = get_duration_scalar(phase_duration[j,],old_durations[i,])
  }
}


```

```{r sup}

### bpsv

bpsv_supply = get_bpsv_supply()

b_supply = bpsv_supply$b_supply
b_alloc = bpsv_supply$b_alloc
bpsv_dose_delivery = bpsv_supply$bpsv_dose_delivery
b_tot = max(b_supply$doses)

```


```{r}

# cost per reserved dose upon delivery
cost_res = rawpar$cost_cogs*(1+rawpar$profit)*(1+rawpar$cost_travel)

bpsv_rd_costsamples_dyd <- bpsv_rd_costsamples_no_d <- bpsvresrd <- 
  inv_cost_per_year <- time_to_bpsv <- bpsvproc <- rep(0,NSAMPLES)
bpsv_rd_py = list(); for(i in 1:2) bpsv_rd_py[[i]] = matrix(0,nrow=NSAMPLES,ncol=15)
for(i in 1:NSAMPLES){
  exi = EX[i,]
  inexi = INEX[i,]
  randd_costs = get_bpsv_costs(b_tot, 
                               cost_res = cost_res,
                               pos = POS_BPSV[i,],
                               pto = PTO_BPSV[i,],
                                exi = exi,
                                inexi = inexi,
                                inex_weight = pardf$inex_weight[i],
                                y_durations = old_durations[i,1:3]/52, # years
                                old_duration = old_durations[i,4], # weeks
                                discount = pardf$discount[i],
                                n_bpsv_p1 = pardf$n_bpsv_p1[i],
                                bpsv_res_upfront = pardf$bpsv_res_upfront[i],
                                n_bpsv_candidates = pardf$n_bpsv_candidates[i],
                                cost_lic = pardf$cost_lic[i],
                                cost_cogs = pardf$cost_cogs[i],
                                cost_ff = pardf$cost_ff[i],
                                cost_travel = pardf$cost_travel[i],
                                profit = pardf$profit[i],
                                bpsv_replenishment = pardf$bpsv_replenishment[i],
                                cost_bpsv_res = pardf$cost_bpsv_res[i])
  
  bpsv_rd_costsamples_dyd[i] = randd_costs[['bpsv_rd_costsamples_dyd']]
  bpsv_rd_costsamples_no_d[i] = randd_costs[['bpsv_rd_costsamples_no_d']]
  bpsv_rd_py[[1]][i,1:length(randd_costs[['bpsv_rd_costsamples_dyd_py']])] = randd_costs[['bpsv_rd_costsamples_dyd_py']]
  bpsv_rd_py[[2]][i,1:length(randd_costs[['bpsv_rd_costsamples_no_d_py']])] = randd_costs[['bpsv_rd_costsamples_no_d_py']]
  bpsvresrd[i] = randd_costs[['bpsvresrd']]
  inv_cost_per_year[i] = randd_costs[['inv_cost_per_year']]
  time_to_bpsv[i] = randd_costs[['time_to_bpsv']]
  bpsvproc[i] = randd_costs[['bpsvproc']]
}

# cost from phase 2 end
##!! wrap
inv_cost = inv_cost_per_year*sapply(1:NSAMPLES,function(x)
  sum(1/(1+pardf$discount[x])^((time_to_bpsv[x]+1):15))
  )
  

```


```{r}

ssv_rd_costsamples <- list()
singlepar <- list()
for(x in 1:length(dms)){
  # ssv_phase_pto[[x]] = matrix(0,NSAMPLES,5)
  ssv_rd_costsamples[[x]] = rep(0,NSAMPLES)
  for(i in 1:NSAMPLES){
    ex = EX[i,]
    cost_lic = pardf$cost_lic[i]
    n_ssv_successes = pardf$n_ssv_successes[i]
    q_ssv_successes = pardf$q_ssv_successes[i]
    randd_costs = get_ssv_randd_costs(timescale = timescale[[x]][i,],
                                      pos = POS_SSV[i,],
                                      exi = exi,
                                      n_ssv_successes = n_ssv_successes,
                                      q_ssv_successes = q_ssv_successes,
                                      cost_lic = cost_lic)
    # ssv_phase_pto[[x]][i,] = randd_costs[['ssv_phase_pto']]
    ssv_rd_costsamples[[x]][i] = randd_costs #[['ssv_rd_costsamples']]
  }
}


```

```{r}

# capacity reservation cost

capres_costs_per_year = list()
for(x in 1:length(crs)){
  capres_costs_per_year[[x]] = rep(0,NSAMPLES)
  for(i in 1:NSAMPLES){
    capres_costs_per_year[[x]][i] = get_cap_res_cost(cap_cost_per_dose = pardf$cost_capres[i], 
                                                     cap_res_vol = crs[x])
  }
}


```

```{r}


## scenario variables  ######################################################

scennames = c('BAU',paste0('S',sprintf("%02d", 1:10)))
nscen = length(scennames)
pop_proportional = c(1,1,1,1,1,2,2,1,2,2,2)
scen_dm = c(1, 1, 1,1, 2,2,2, 3,3,3, 1)
scen_capres = c(1, 1, 2,3, 1,2,3, 1,2,3, 1)
bpsv_scen = rep(F,length(scennames))
bpsv_scen[2] = T

rates = matrix(rep(basic_rates, nscen), ,ncol=NLEVELS,byrow=T)
rates[nscen,3:4] = 0.04



```


```{r}
printmath = function(eqtext){
  if (knitr::is_html_output()) {
    cat(paste0("```math\n",eqtext,"\n```",collapse=''))
  } else {
    cat(paste0("$$\n",eqtext,"\n$$",collapse=''))
  }
}
```



# Preparedness cost equation 


<span style="color:red;"> (BPSV R&D + BPSV Stockpile + SARS-X Reserved capacity + Enabling activities) / (1 + discount rate) ^ (year – 2025) </span>



```{r}
eqtext = 'D_y^{\\text{(prep)}} = \\frac{1}{(1+r)^y}\\left(D_s^{\\text{(BP-adRD)}} + D_{s,y}^{\\text{(BP-man)}} + D_{s,y}^{\\text{(BP-inv)}} + D_s^{\\text{(S-cap)}} + D_{s,y}^{\\text{(en)}}\\right)'
printmath(eqtext)
```

- $D_s^{\text{(BP-adRD)}}$ is the R\&D cost of BPSV prior to an outbreak; see Equation \@ref(eq:bpsvrd)
- $D_{s,y}^{\text{(BP-man)}}$ is the upfront cost of maintaining an investigational reserve of 100,000 BPSV doses; see Equation \@ref(eq:bpsvadman)
- $D_{s,y}^{\text{(BP-inv)}}$ is the annual cost of maintaining an investigational reserve of 100,000 BPSV doses; see Equation \@ref(eq:bpsvinv)
- $D_s^{\text{(S-cap)}}$ is the cost of reserved capacity for SSV; see Equation \@ref(eq:ssvcap)
- $D_{s,y}^{\\text{(en)}}$ is the annual cost of enabling activities; see Equation \@ref(eq:enable).


## BPSV advanced R\&D

**These values match the spreadsheet results**



| Developer | Licensure Experience | 
|---|---| 
| CalTech | No | 
| SK Bio | Yes | 
| Codiak | No | 
| Panacea | No | 
| NEC Onco| No | 
| Intravacc | No | 
| VIDO | No | 
| IVI | No | 

Table: (\#tab:inex) Manufacturers working on BPSV and whether or not they have licensure experience 

 



Probabilities of success for preclinical, Phase I, Phase II, and Phase III are $P_0$, $P_1$, $P_2$ and $P_3$. Then probabilities of occurrence are:

```{r}
eqtext = '\\hat{P}_i^{(0)} = \\left\\{\\begin{array}{lr}1 & i=0 \\\\ 
\\prod_{j=0}^{i-1}P_j & i>0 
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("```math\n",eqtext,"\n```",collapse=''))
} else {
  cat(paste0("$$\n",eqtext,"\n$$",collapse=''))
}
```

for $i \in \{0,1,2,3,4\}$, with $i=4$ corresponding to licensure. 

For $N^{\text{(BPSV-1)}} = `r rawpar$n_bpsv_p1`$ candidate(s), which have already been through the preclinical phase, we have

```{r}
eqtext = '\\hat{P}_i^{(1)} = \\left\\{\\begin{array}{lr}1 & i=1 \\\\ 
\\prod_{j=1}^{i-1}P_j & i>1 
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("```math\n",eqtext,"\n```",collapse=''))
} else {
  cat(paste0("$$\n",eqtext,"\n$$",collapse=''))
}
```

for $i \in \{1,2,3,4\}$.

The cost of each phase is $T_i$, a weighted average of experienced and inexperienced manufacturers (with $\omega = `r rawpar$inex_weight`$):

<!-- $$T_{i} = (1+I)(\omega T_i^{(n)} + (1-\omega)T_i^{(e)}).$$  -->

```{r}
eqtext = 'T_{i} = (1+I)(\\omega T_i^{(n)} + (1-\\omega)T_i^{(e)})'
printmath(eqtext)
```


where $I = `r rawpar$inflation`$ is inflation from 2018 to 2025. Then the total weighted cost for phases 0 through 2 for $N^{\text{(BPSV)}}$ candidates is



```{r}
eqtext = 'D_s^{\\text{(BP-adRD)}} = \\left\\{\\begin{array}{lr}
 \\left(N^{\\text{(BPSV)}}-N^{\\text{(BPSV-1)}}\\right)\\sum_{i=0}^2 \\hat{P}_i^{(0)}T_{i} + N^{\\text{(BPSV-1)}}\\sum_{i=1}^2 \\hat{P}_i^{(1)}T_{i} \\; & \\; s=1 \\\\
0  \\; & \\; s\\neq 1
\\end{array}\\right.
(\\#eq:bpsvrd)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}


```

```{r posbpsv,fig.cap='Risk-adjusted R&D cost for 8 BPSV candidates'}


ggplot() + geom_histogram(aes(bpsv_rd_costsamples_dyd)) +
  theme_bw(base_size=15) +
  labs(x='Billion USD',y='',title='')


print(round(summary(bpsv_rd_costsamples_dyd),2))

```

Target: 146 (103 135 177)



## BPSV investigational reserve

```{r}

bpsv_upfront = pardf$bpsv_res_upfront*pfixed$bpsv_inv_res/1e6 # millions


```

**The annual cost annual is correct, at around 162 thousand, but the total cost is slightly too high**


The time taken to complete development of the BPSV up to the end of phase II, from which point it is manufactured to be held in an investigational reserve, is:


```{r}
eqtext = 'Y^{(B)} = Y_0^{(B)} + Y_1^{(B)} + Y_2^{(B)}.'
printmath(eqtext)
```

The upfront cost of securing the investigational reserve is

```{r}
eqtext = 'D_{s,y}^{\\text{(BP-man)}} = \\left\\{\\begin{array}{lr}
 A_4A_5
\\; & \\; s=1 \\;\\&\\;y=Y^{(B)}+1\\\\
0  \\; & \\; s\\neq 1\\;\\|\\;y\\neq Y^{(B)}+1
\\end{array}\\right.
(\\#eq:bpsvadman)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

where $A_4 =`r format_to_print(rawpar$bpsv_inv_res)`$ is the size of the reserve and $A_5 =`r format_to_print2(rawpar$bpsv_res_upfront,3)`$ is the cost per dose in USD.

The cost of goods supplied is $G = `r rawpar$cost_cogs`$. Then the cost of drug substance is $G(1-M_f)(1+M_p) = `r round(rawpar$cost_cogs*(1-rawpar$cost_ff)*(1+rawpar$profit),2)`$ USD per dose. The reserve is replenished every $Y_{rep} = `r rawpar$bpsv_replenishment`$ years. Then the annual cost to maintain the reserve of $A_4 =`r format_to_print(rawpar$bpsv_inv_res)`$ doses is

```{r}
eqtext = 'D_{s,y}^{\\text{(BP-inv)}} = \\left\\{\\begin{array}{lr}
 \\frac{A_4}{Y_{rep}}G  (1-M_f)(1+M_p) + A_1
\\; & \\; s=1 \\;\\&\\;y>Y^{(B)}\\\\
0  \\; & \\; s\\neq 1\\;\\|\\;y\\leq Y^{(B)}
\\end{array}\\right.
(\\#eq:bpsvinv)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

where $A_1 = `r round(rawpar$cost_bpsv_res,2)`$ USD is the annual reservation cost per dose.

```{r bpsvinv,fig.cap='BPSV investigational reserve costs accumulated from the completion of Phase II to year 15 with uniformly distributed discount rate.'}


ggplot() +
  geom_histogram(aes(x=inv_cost*1e3)) +
  theme_bw(base_size = 15) +
  labs(x='Cost up to year 15, million USD',y='')


print(round(summary(inv_cost*1e3),2))

```

Target: 1 (0.9 1 1.1)

## SSV capacity reservation

**This matches the spreadsheet results.**


The cost per dose reservation per year is $A_2 = `r round(rawpar$cost_capres,2)`$ USD. Reservation sizes, in billions, depend on scenarios, including the $A_3 = `r rawpar$hic_cap_res`$ billion doses reserved for HIC, as follows:

```{r}
eqtext = 'M_{R,s} = \\left\\{\\begin{array}{lr}A_3 & s\\in\\{0, 1, 4, 7, 10\\} \\\\ 
A_3+0.7 & s\\in\\{2, 5, 8\\} \\\\ 
A_3+2 & s\\in\\{3, 6, 9\\} \\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

Then the total cost per year is


```{r}
eqtext = 'D_s^{\\text{(S-cap)}} =  M_{R,s} A_2
(\\#eq:ssvcap)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

The annual costs in billion USD are `r round(0.5*rawpar$cost_capres,2)`, `r round(1.2*rawpar$cost_capres,2)`, and `r round(2.5*rawpar$cost_capres,2)`, respectively.

```{r capres,fig.cap='Capacity reservation costs accumulated over 15 years with uniformly distributed discount rate.'}

##!! wrap
capres_costs = as.data.frame(do.call(rbind,lapply(1:length(crs),function(x) cbind( capres_costs_per_year[[x]]*fifteen_yr_discount_weight, crs[x]))))

ggplot(capres_costs) +
  geom_boxplot(aes(x=factor(V2,levels=crs),y=V1)) +
  theme_bw(base_size = 15) +
  labs(x='Capacity reservation, billion doses',y='Cost, billion USD')


for(i in unique(capres_costs$V2)){
  subs = subset(capres_costs,i==V2)
  cat(i)
  cat('\n')
  print(round(summary(subs$V1),2))
  cat('\n')
}

```

Targets: 
3,086	(2,897 3,074 3,269)

7,407	(6,954 7,378 7,845)	

15,431	(14,487	15,370	16,344)
		



## Enabling activities

**This matches the spreadsheet results**


Denote the "Days Mission" by $\zeta$, so that $\zeta\in\lbrace 365, 200, 100 \rbrace$. Then annual costs, $E=700$ million, accumulate depending on the year and the mission:

```{r}
eqtext = 'D_{s,y}^{\\text{(en)}} = \\left\\{\\begin{array}{lr}E & \\zeta(s)=200 \\;\\&\\; y\\leq 5 \\; |\\; \\zeta(s)=100\\; \\& \\;y\\leq 15 \\\\ 
0 & \\zeta(s)=365 \\;|\\; y > 15 \\;|\\; \\zeta(s)=200 \\;\\&\\; y \\;>\\; 5  \\end{array}\\right.
(\\#eq:enable)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

For our scenarios, we have 


```{r}
eqtext = '\\zeta(s) = \\left\\{\\begin{array}{lr} 365 & s\\in\\{0, 1, 2, 3, 10\\} \\\\ 
200 & s\\in\\{4, 5, 6\\} \\\\ 
100 & s\\in\\{7, 8, 9\\} \\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```


```{r en,fig.cap='Enabling costs accumulated over 15 years with uniformly distributed discount rate.'}


enabling_costs = as.data.frame(do.call(rbind,lapply(1:length(dms),function(x) cbind(dms[x],  enabling_costs_list[[x]]))))

ggplot(enabling_costs) +
  geom_boxplot(aes(x=factor(V1,levels=dms),y=V2/1e3)) +
  theme_bw(base_size = 15) +
  labs(x='Days Mission',y='Cost, billion USD')

for(i in unique(enabling_costs$V1)){
  subs = subset(enabling_costs,i==V1)
  cat(i)
  cat('\n')
  print(round(summary(subs$V2/1e3),2))
  cat('\n')
}


```

Targets:

3,242	(3,182 3,241 3,302)

8,126 (7,629 8,094 8,607)


# Response cost equation 


<span style="color:red;"> (BPSV R&D + SARS-X R&D + BPSV Procurement + SARS-X Procurement + BPSV Delivery + SARS-X Delivery) / (1 + discount rate) ^ (year – 2025) </span>




```{r}
eqtext = 'D_{s,y}^{\\text{(res)}} = \\frac{1}{(1+r)^y}\\left(D_{s,y}^{\\text{(BP-resRD)}} + D_{s,y}^{\\text{(S-RD)}} + D_{s,y}^{\\text{(BP-proc)}} + D_{s,y}^{\\text{(S-proc)}} + D_{s,y}^{\\text{(BP-del)}} + D_{s,y}^{\\text{(S-del)}}\\right)'
printmath(eqtext)
```


- $D_{s,y}^{\text{(BP-resRD)}}$ is the R\&D cost of BPSV after an outbreak; see Equation \@ref(eq:bpsvresrd)
- $D_{s,y}^{\text{(S-RD)}}$ is the R\&D cost for SSV; see Equation \@ref(eq:ssvrd)
- $D_{s,y}^{\text{(BP-proc)}}$ is the cost of procuring BPSV; see Equation \@ref(eq:bpsvproc)
- $D_{s,y}^{\text{(S-proc)}}$ is the cost of procuring SSV; see Equation \@ref(eq:ssvproc)
- $D_{s,y}^{\text{(BP-del)}}$ is the cost of delivering BPSV; see Equation \@ref(eq:bspvdel)
- $D_{s,y}^{\text{(S-del)}}$ is the cost of delivering SSV; see Equation \@ref(eq:ssvdel)





## Risk-adjusted R&D cost per candidate calculation


### SSV

**These don't match the spreadsheet results. Values too low.**

Trial costs are adjusted for the duration of the trial, which depend on the R\&D investment, denoted $\zeta\in\lbrace 365, 200, 100\rbrace$: 



```{r}
eqtext = 'T_{\\zeta,i}^{(e)} = (1+I)\\frac{W_{i;\\zeta}^{(S)}}{52Y_{i}^{(B)}}T_i^{(e)}'
printmath(eqtext)
```


where $I = `r rawpar$inflation`$ is inflation from 2018 to 2025. 

The probability of success of each phase comes from COVID-19 data.


```{r}
eqtext = 'P_i^{\\text{(SSV)}} \\sim \\text{Beta}\\left(\\sum_{j=i+1}^4X_j+1, X_i + 1 \\right)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

for $i \in \lbrace 0,1,2,3 \rbrace$ where $X_i$ is the number of candidates that failed in phase $i$ and $X_4$ the number that succeeded.

Then the total cost is


```{r}
eqtext = 'D_s^{\\text{(S-RD)}} = N^{\\text{(SSV)}}\\left(\\sum_{i=0}^3 \\hat{P}_i^{\\text{(SSV)}} \\cdot T_{\\zeta(s),i}^{(e)} +  \\hat{P}_4^{\\text{(SSV)}} T_4\\right)
(\\#eq:ssvrd)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```



We multiply by the number of candidates, $N^{\text{(SSV)}}$, to get the total cost from the weighted average per candidate, where


```{r}
eqtext = 'N^{\\text{(SSV)}} = n^{\\text{(SSV)}} + F^{-1}_{NegBin}\\left(Q^{\\text{(SSV)}}; n^{\\text{(SSV)}},  \\hat{P}_3^{\\text{(SSV)}} \\right)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

is chosen to secure at least $n^{\text{(SSV)}} = `r rawpar$n_ssv_successes`$ successful candidates with probability $Q^{\text{(SSV)}} = `r 100*rawpar$q_ssv_successes`$%. Here, $F^{-1}_{NegBin}\left(q; n,  p \right)$ is the cumulative density of a negative binomial distribution with parameters $n$ and $p$ evaluated at quantile $q$.

```{r posssv,fig.cap='Risk-adjusted R&D cost for 18 SSV candidates'}

# prep for plot
ssv_rd_costsamples_lab = lapply( 1:length(ssv_rd_costsamples), function(x) cbind( ssv_rd_costsamples[[x]], paste0(dms[x], ' Days Mission')) )

n_ssv_successes = pardf$n_ssv_successes
q_ssv_successes = pardf$q_ssv_successes

n_ssv_candidates = n_ssv_successes + qnbinom(q_ssv_successes,size = n_ssv_successes, prob = PTO_SSV[,4])

ssv_rd_plot <- as.data.frame(do.call(rbind,ssv_rd_costsamples_lab))
colnames(ssv_rd_plot) = c('Cost','Investment')
ssv_rd_plot$Cost = as.numeric(ssv_rd_plot$Cost)
ggplot(ssv_rd_plot) + geom_histogram(aes(Cost/1e3)) +
  facet_wrap(~Investment) +
  theme_bw(base_size=15) +
  labs(x='Billion USD',y='',title='')


pander(as.data.frame(cbind(DM=dms,do.call(rbind,lapply(unique(ssv_rd_plot$Investment), function(i){
  subs = subset(ssv_rd_plot, Investment==i)
  round(summary(subs$Cost*at_yr_15))
}
)))))

```


Targets:

284 (105 170 283)

195 (61 97 164)

118 (35 61 108)




### BPSV

**This is a little higher than the spreadsheet results**


**I have basically assumed the same as SSV except for the numbers given (8 candidates and 18 weeks)**


The BPSV has $N^{\text{(BPSV)}}$ candidates. Those that have passed through Phases 0 to 2 prior to the outbreak go through Phase 3 during the response. The duration is $W_3^{(B)}=18$ weeks. Thus we write the BPSV R\&D response cost


```{r}
eqtext = 'D_s^{\\text{(BP-resRD)}} = \\left\\{\\begin{array}{lr}N^{\\text{(BPSV)}}\\hat{P}_3\\left( (1+I)\\frac{W_3^{(B)}}{52Y_3^{(B)}}T_3^{(e)} + P_3 T_4\\right) \\; & \\; s=1 \\\\
0  \\; & \\; s\\neq 1
\\end{array}\\right.
(\\#eq:bpsvresrd)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```


```{r bpsvresrd,fig.cap='Reactive R&D cost for BPSV'}

ggplot() + geom_histogram(aes(bpsvresrd)) +
  theme_bw(base_size=15) +
  labs(x='Cost, million USD',y='',title='')

print(round(summary(bpsvresrd*at_yr_15),1))

```

Target: 14 (3 5 10)



## Procurement cost calculation

The cost per dose comes from the cost of goods supplied ($G = `r rawpar$cost_cogs`$) adjusted for profits ($M_p = `r rawpar$profit`$) and the transportation cost ($M_t = `r rawpar$cost_travel`$).

$S_R = G(1+M_p)(1+M_t)$ evaluates to `r round(cost_res,2)`.

This cost is used both for SSV doses manufactured using reserved capacity, and all newly manufactured BPSV doses.

### SSV

**These values are close, but not identical, to the spreadsheet results if I adjust for the total demand**


We write billion doses procured from channel $x\in\lbrace R,E,B \rbrace$ in year $y$ and scenario $s$ as $A_{x,s,y}$ (see Equation \@ref(eq:supply)). Then the total cost, in billion USD, is:


```{r}
eqtext = 'D_{s,y}^{\\text{(S-proc)}} = A_{R,s,y} S_R  + \\sum_{x\\in\\lbrace E,B \\rbrace}  A_{x,s,y} S_U
(\\#eq:ssvproc)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

Here, $S_R = `r round(cost_res,2)`$ is the cost per reserved dose and $S_U = `r round(rawpar$cost_un,2)`$ the cost per unreserved dose in USD. 




```{r ssvsup}

supplies <- cumulative <- list()

for(s in 1:nscen){
  ssv_supply = get_ssv_supply(dm=dms[scen_dm[s]], 
                              capres=crs[scen_capres[s]], 
                              bpsv=bpsv_scen[s],
                              weeks_init = WEEKS_INIT,
                              weeks_scale = WEEKS_SCALE)
  
  supplies[[s]] = ssv_supply[['supplies']]
  cumulative[[s]] = ssv_supply[['cumulative']]
}


```

```{r}

# some variables need to be fixed atm as they feed into delivery trajectories
pfixed = list()
pfixed$hic_cap_res = rawpar$hic_cap_res

cost_per_year <- ssv_proccost_discounted <- ssv_proccost_undiscounted <- list()

## ssv allocation 

function_list = list(res=allocate_res_doses, ex=allocate_exbui_doses, bui=allocate_exbui_doses)
rep_res = list(res=allocate_res_doses, ex=allocate_res_doses, bui=allocate_res_doses)

time_to_approval = round(dms/7)
alloc <- second_dose_delivery <- all_dose_delivery <- list()


for(s in 1:nscen){
  cost_per_year[[s]] = matrix(0, nrow=NSAMPLES, ncol=NYEARS+1)
  ssv_proccost_discounted[[s]] <- ssv_proccost_undiscounted[[s]] <- rep(0, NSAMPLES)
  
  # allocation
  allocation_functions = list(function_list, rep_res)[[pop_proportional[s]]]

  alloc_and_del = allocate_and_deliver_doses(allocation_functions, supplies[[s]], del_rates=rates[s,],
                                             time_to_approval=time_to_approval[scen_dm[s]], 
                                           hic_only = pfixed$hic_cap_res/(crs[scen_capres[s]]+pfixed$hic_cap_res))
  
  alloc[[s]] = alloc_and_del[['alloc']]
  alloc[[s]]$Scenario = scennames[s]
  second_dose_delivery[[s]] = alloc_and_del[['second_dose_delivery']]
  all_dose_delivery[[s]] = alloc_and_del[['all_dose_delivery']]
  
  
  total_doses = annualise_ssv_procurement(supplies[[s]], alloc[[s]], cap_res=pfixed$hic_cap_res + crs[scen_capres[s]])
  for(i in 1:NSAMPLES){
    cost_un = pardf$cost_un[i]
    cost_res = pardf$cost_cogs[i]*(1+pardf$profit[i])*(1+pardf$cost_travel[i])
    ssv_procurement_costs = get_ssv_procurement_costs(ssv_py_inc_booster=total_doses, 
                                                      cost_res=cost_res, 
                                                      cost_un=cost_un)
    
    
    ssv_proccost_discounted[[s]][i] = sum(sapply(1:NYEARS,function(x) ssv_procurement_costs/(1+pardf$discount[i])^x))
    ssv_proccost_undiscounted[[s]][i] = sum(ssv_procurement_costs)/1e3 # billions to millions
  }
  cost_per_year[[s]] = c(ssv_procurement_costs, scennames[s])
}

```


```{r costperyear,fig.cap='SSV procurement cost'}


cpy = data.frame(do.call(rbind,cost_per_year))
colnames(cpy) = c(paste0('Year ',1:NYEARS),'Scenario')
cpymelt = reshape2::melt(cpy,id.vars='Scenario')
cpymelt$variable = as.numeric(cpymelt$variable)
cpymelt$value = as.numeric(cpymelt$value)

ggplot(cpymelt) + 
  geom_line(aes(x=variable,y=value/1e3,colour=Scenario)) +
  theme_bw(base_size=15) +
  labs(x='Year',y='Procurement cost, billion USD')


pander(as.data.frame(cbind(Scenario=scennames,do.call(rbind,lapply(cost_per_year, function(x)round(summary(20.884/2/(sum(DEMAND15)/1e9)*rowSums(sapply(1:NYEARS,function(y) as.numeric(x[y])/(1+rawpar$discount)^c(15+y))))))))),caption = 'Costs summed and discounted from year 16 to year 20, million USD')




```



Targets:

184,127	(	151,271	180,171	214,966	)
187,255	(	154,376	183,358	218,147	)
167,519	(	137,713	163,938	195,495	)
135,910	(	111,925	133,050	158,444	)
189,820	(	157,000	185,976	220,684	)
169,549	(	140,293	166,133	197,067	)
141,440	(	117,134	138,613	164,309	)
189,878	(	157,295	186,091	220,526	)
168,378	(	139,564	165,035	195,494	)
137,984	(	114,513	135,278	160,078	)
178,766	(	146,883	174,927	208,686	)



### BPSV

**This is pretty close**


```{r}
eqtext = 'D_s^{\\text{(BP-proc)}} = \\left\\{\\begin{array}{lr}
A_{BPSV,s}\\cdot S_R +  A_4(M_f+M_t)(1+M_p)G\\; & \\; s=1 \\\\
0  \\; & \\; s\\neq 1
\\end{array}\\right.
(\\#eq:bpsvproc)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```


For a world population aged 65 and over of `r round(sum(POPS65)/1e9,1)` billion, an uptake of `r 100*rawpar$final_vaccine_coverage`\% (accounting for wastage of `r round(100*rawpar$vaccine_wastage)`\%), and a cost per dose of $S_R = `r round(cost_res,2)`$ USD (the same as for SSV via reserved capacity), the procurement cost for BPSV is `r round(bpsvproc[1]/1e3,2)` billion USD.

Although `r b_tot` billion doses are manufactured, as manufacturing stops once one billion doses have been made.



```{r}

print(round(summary(bpsvproc*at_yr_15),2))


```


Target: 3,628 (3,062 3,568 4,165)


## Delivery Cost Equation


### SSV

**These values are ballpark correct but too concentrated**

For populations aged 15 and above $N_i^{(15)}$ in income group $i\in\lbrace\text{LIC, LMIC, UMIC, HIC}\rbrace$, we write 


```{r}
eqtext = 'L_i = 2\\cdot \\lambda\\cdot N_i^{(15)}'
printmath(eqtext)
```

as the total demand for first-schedule doses for income group $i$, representing two doses each for $\lambda = `r rawpar$final_vaccine_coverage*100`$\% of the population.

We write the delivery cost for $h_{s,i,w}$ doses given in week $w$ and country type $i$ as follows. There are three cost tiers, the first of which is applied to the first 10\% of $L_i$, the second to the subsequent 20\%, and the third to all doses thereafter. The same costing schedule applies both to the first-schedule plus booster SSV doses and the BPSV rollout. 

```{r}
eqtext = 'H_{s,i,w} = 
\\left\\{\\begin{array}{lr}
V_{i; 0}h_{s,i,w}  & \\sum_{j=1}^{w-1}h_{s,i,w}\\leq \\frac{1}{10}L_i \\\\
V_{i; 10}h_{s,i,w}  & \\frac{1}{10}L_i < \\sum_{j=1}^{w-1}h_{s,i,w}\\leq \\frac{3}{10}L_i  \\\\
V_{i; 30}h_{s,i,w}  & \\frac{3}{10}L_i < \\sum_{j=1}^{w-1}h_{s,i,w}
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```


Then the delivery cost in year $y$ and scenario $s$ is

```{r}
eqtext = 'D_{s,y}^{\\text{(S-del)}} = 
\\sum_{w\\in y} \\sum_i H_{s,i,w}
(\\#eq:ssvdel)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```



<!-- We set  -->

<!-- $$V_{LLMIC; j} = \frac{1}{N_{LMIC}^{(15)} + N_{LIC}^{(15)}} \left(N_{LMIC}^{(15)}V_{LMIC; j} + N_{LIC}^{(15)}V_{LIC; j} \right)$$ -->



```{r ssvallocation}


# 
# ggplot(subset(do.call(rbind,second_dose_delivery),Scenario%in%scennames)) +
#   geom_line(aes(x=Week,colour=Scenario,y=doses)) +
#   facet_wrap(~factor(il,levels=INCOMELEVELS)) +
#   theme_bw(base_size = 15) +
#   scale_x_continuous(limits=c(0,100)) +
#   labs(x='Week',y='Second-dose coverage, percent population',colour='Scenario')

```


```{r deliverycost,fig.cap='SSV delivery cost'}

## cost delivery

# apply costs per dose to quantiles
##!! can just apply values to the total (rather than going week by week) if there is no discounting
ssv_delivery_costs_list = list()
for(s in 1:length(scennames)){
  ssv_delivery_costs_list[[s]] = rep(0,NSAMPLES)
  for(i in 1:NSAMPLES){
    # cost_per_dose_mat = matrix(0,nrow=length(INCOMELEVELS), ncol=length(PC_THRESHOLDS))
    # for(il in 1:length(INCOMELEVELS))
    #   for(j in 1:length(PC_THRESHOLDS)){
    #     lab = paste0('cost_',tolower(INCOMELEVELS)[il],'_',as.numeric(PC_THRESHOLDS[j]))
    #     cost_per_dose_mat[il,j] = cost_per_dose[[lab]][i]
    #   }
        
    cost_per_dose = COST_PER_DOSE_LIST[[i]]
    discount = pardf$discount[i]
    
    ssv_delivery_costs = get_ssv_delivery_costs(all_ssv_delivered = all_dose_delivery[[s]], 
                                                     cost_per_dose = cost_per_dose,
                                                     discount = discount)
    dis_ssv_delivery_costs = ssv_delivery_costs[['dis_countrycosts']]
    # ssv_delivery_costs = ssv_delivery_costs[['countrycosts']]
    
    ssv_delivery_costs_list[[s]][i] = dis_ssv_delivery_costs
  }
}

ssv_delivery_costs = as.data.frame(do.call(cbind,ssv_delivery_costs_list))
colnames(ssv_delivery_costs) = scennames

ggplot(reshape2::melt(ssv_delivery_costs)) +
  geom_boxplot(aes(x=variable,y=value/1e3,colour=variable),show.legend=F) +
  theme_bw(base_size=15) +
  labs(x='',y='SSV delivery cost, billion USD')

print(t(summary(ssv_delivery_costs*at_yr_15)))

```

Targets:

114,526	(	90,654	110,005	134,444	)
114,771	(	91,321	111,130	134,341	)
114,769	(	91,620	110,604	133,752	)
114,811	(	91,647	110,815	133,856	)
114,527	(	91,170	110,664	133,720	)
114,615	(	91,074	110,653	133,836	)
115,095	(	91,858	111,205	134,355	)
115,634	(	92,514	111,639	134,375	)
116,385	(	93,116	112,183	135,664	)
117,196	(	93,427	113,114	136,861	)
116,913	(	93,536	112,957	136,414	)
118,141	(	94,682	114,649	137,100	)
113,540	(	89,745	109,012	132,595	)






### BPSV

**These values match the spreadsheet results. (NB: more doses are purchased and delivered than there are eligible people in the population)**


For the BPSV, which goes only to people aged 65 or older, with populations $N_i^{(65)}$, coverage is reached earlier in the process, so the cost is weighted more heavily towards start up and ramp up:


```{r}
eqtext = 'D_s^{\\text{(BP-del)}} = 
\\left\\{\\begin{array}{lr}
\\sum_{i}D_{\\text{BPSV},i}
\\; & \\; s=1 \\\\
0  \\; & \\; s\\neq 1
\\end{array}\\right.
(\\#eq:bspvdel)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```



```{r}
eqtext = 'D_{\\text{BPSV},i} = 
\\left\\{\\begin{array}{lr}
N_i^{(65)}V_{i; 0}  & N_i^{(65)}\\leq \\frac{1}{10}N_i^{(15)} \\\\
\\frac{N_i^{(15)}}{10} V_{i; 0} + \\left(N_i^{(65)}-\\frac{N_i^{(15)}}{10} \\right)V_{i; 11}  & \\frac{1}{10}N_i^{(15)} < N_i^{(65)}\\leq \\frac{3}{10}N_i^{(15)} \\\\
\\frac{N_i^{(15)}}{10} V_{i; 0} + \\frac{2}{10}N_i^{(15)} V_{i; 11} + \\left(N_i^{(65)}-\\frac{3}{10}N_i^{(15)} \\right)V_{i; 31} & N_i^{(65)}> \\frac{3}{10} N_i^{(15)}
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

The logic of this is as follows:

- The increments in cost correspond to numbers of eligible people in the whole population, namely those aged 15 and above.
- If the number of people eligible for the BPSV is less than 10\% of the population aged 15 and over, then all doses cost the "start up" amount.
- If the number of people eligible for the BPSV is more than 10\% and less than 30\% of the 15+ population, then cost of the first doses, a number equal to 10\% of the 15+ population, is the "start up" amount. All remaining doses cost the "ramp up" amount.
- If the number of people eligible for the BPSV is more than 30\% of the 15+ population, then the cost of the first doses, a number equal to 10\% of the 15+ population, is the "start up" amount. The cost of the second tranche of doses, a number equal to 20\% of the 15+ population, is the "ramp up" amount. All remaining doses cost the "getting to scale" amount.


```{r bpsvdeliverycost,fig.cap="BPSV delivery cost"}

# points at which costs shift per income level (ignoring the 80% mark)
# del_cost_thresholds = sapply(c(1,3)/10,function(x) x*pops3) 

bpsv_del_cost = rep(0,NSAMPLES)
for(i in 1:NSAMPLES){
  cost_per_dose_mat = COST_PER_DOSE_LIST[[i]]
  bpsv_del_cost[i] = get_bpsv_del_costs(bpsv_dose_delivery=bpsv_dose_delivery, 
                                        cost_per_dose_mat=cost_per_dose_mat)
}

ggplot() + geom_histogram(aes(x=bpsv_del_cost/1e3)) +
  theme_bw(base_size = 15) +
  labs(x='BPSV delivery cost, billion USD',y='')

print(round(summary(bpsv_del_cost*at_yr_15),2))
  
```


Target: 11,206 (9,037 10,865 13,054)



| Country | Country status | Study type | Financial Cost per dose (USD) | Source |
|---|---|---|---|---|
| WHO, Gavi, and UNICEF AMC Estimate | AMC | Top down | 1.66 | @Griffiths2021 |
| UNICEF Global Estimate |  All | Model | 0.73 | @Oyatoye2023 |
| DRC | LIC | Bottom up | 1.91 | @Moi2024 |
| Malawi | LIC | Bottom up | 4.55 | @Ruisch2025 |
| Mozambique | LIC | Bottom up | 0.5 | @Namalela2025 |
| Uganda | LIC | Bottom up | 0.79 | @Tumusiime2024 |
| Bangladesh | LMIC | Bottom up | 0.29 | @Yesmin2024 |
| Cote d'Ivoire | LMIC | Bottom up | 0.67 | @Vaughan2023 |
| Nigeria | LMIC | Bottom up | 0.84 | @Noh2024 |
| Philippines | LMIC | Bottom up | 2.16 | @Banks2023 |
| Vietnam | LMIC | Bottom up | 1.73 | @Nguyen2024 |
| Ghana | LMIC | CVIC tool | 2.2--2.3 | @Nonvignon2022 |
| Lao PDR | LMIC | CVIC tool | 0.79--0.81 | @Yeung2023 |
| Kenya | LMIC | Top down | 3.29--4.28 | @Orangi2022 | 
| Botswana | UMIC | Mixed | 19 | @Vaughan2025 |
| South Africa | UMIC | Top down | 3.84 | @Edoka2024 | 

Table: (\#tab:delcosts) Literature review of global and country-specific delivery costs 






```{r}

missions = paste0(dms[2:3],' days to SSV')
capas = paste0(crs[2:3],' billion capacity')

```




```{r}

## bringing together preparedness costs

iqrs = c(1:3)/4

# bpsv_rd_costsamples_dyd
bpsv_rd_prep = as.data.frame(t(quantile(bpsv_rd_costsamples_no_d/1e3,iqrs)))
bpsv_rd_prep$timing = 'Upfront'
bpsv_rd_prep$category = 'R&D'
bpsv_rd_prep$type = 'BPSV'


# enabling_costs
enab = as.data.frame(t(sapply(c(5,15),function(x) quantile(rawpar$cost_enab*x,iqrs)/1e3)))
enab$timing = 'Upfront'
enab$category = 'R&D'
enab$type = missions

# rbind(enab, bpsv_rd_prep)

# upfront cost in million dollars
bpsv_man = as.data.frame(t(quantile(bpsv_upfront/1e3,iqrs)))
bpsv_man$timing = 'Upfront'
bpsv_man$category = 'Manufacturing'
bpsv_man$type = 'BPSV'

# inv_cost in millions
bpsv_inv_prep = as.data.frame(t(quantile(inv_cost_per_year,iqrs)))
bpsv_inv_prep$timing = 'Per year'
bpsv_inv_prep$category = 'Manufacturing'
bpsv_inv_prep$type = 'BPSV'


# capres_costs
ssv_capres = as.data.frame(t(sapply(crs[2:3],function(x) quantile(x*rawpar$cost_capres,iqrs))))
ssv_capres$timing = 'Per year'
ssv_capres$category = 'Manufacturing'
ssv_capres$type = capas

timings = c('Upfront','Per year','Per pandemic')
types = c('BPSV', missions, capas, 'Equality + Delivery')
prepdata = rbind(enab, bpsv_rd_prep,bpsv_man,bpsv_inv_prep, ssv_capres)
prepdata$timing = factor(prepdata$timing,levels=timings,labels=timings)
prepdata$type = factor(prepdata$type,levels=types,labels=types)
# ggplot(prepdata) + theme_bw(base_size = 15) +
#   geom_hline(yintercept=0,colour='grey') +
#   geom_vline(xintercept=0,colour='grey') +
#   facet_wrap(~timing, scales='free') +
#   geom_bar(aes(x=type,y=`50%`,fill=category),stat = 'identity', position = 'dodge') +
#   geom_errorbar(position = position_dodge(width = 0.9), width=0.6,aes(x=type,group=category,ymin=`25%`,ymax=`75%`),show.legend = F) +
#       theme(axis.text.x = element_text(angle = 60,  hjust=1,vjust=1)) +
#   labs(x='',y='Million USD',fill='',size='',title='Costs vs. BAU')

```


```{r}
# enabling r&d accumulating over time

costperyear = rawpar$cost_enab/1e3
d100 = rep(costperyear,15)
d200 = c(rep(costperyear,5),rep(0,10))


years = 1:15
x=1
d100d = t(sapply(years,function(x) quantile(d100[x]/(1+pardf$discount)^(x-1),c(1,3)/4)))
d200d = t(sapply(years,function(x) quantile(d200[x]/(1+pardf$discount)^(x-1),c(1,3)/4)))

df = (rbind(data.frame(years, m=cumsum(d100), apply(d100d,2,cumsum), d='100 days'), 
      data.frame(years, m=cumsum(d200), apply(d200d,2,cumsum), d='200 days'),
      data.frame(years, m=0, X25. = 0, X75. = 0, d='BAU')))

rdplot = ggplot(df)  +
  geom_ribbon(aes(x=years-1,ymin=(X25.),ymax=(X75.), fill=d, group=d),alpha=0.5, colour=NA,show.legend = F) + 
  geom_line(aes(x=years-1,y=(m),colour=d)) + 
  scale_x_continuous(n.breaks = 8)+# = seq(0,to=max(years),by=3)) +
  theme_bw(base_size = 16) + 
  labs(x='Year',y='Billion USD',colour='Target') +
  theme(legend.position = 'top')
ggsave(rdplot, filename='rdplot.png')


costperyear = sapply(crs+pfixed$hic_cap_res, function(x) rawpar$cost_capres*x)
df = do.call(rbind, lapply(1:length(crs),function(y)
  data.frame(
    apply(t(sapply(years,function(x) quantile(costperyear[y]/(1+pardf$discount)^(x-1),c(1,3)/4))),2,cumsum), 
    m=cumsum(rep(costperyear[y],15)),years, d=as.character(crs[y]+pfixed$hic_cap_res))
))

capresplot = ggplot(df)  +
  geom_ribbon(aes(x=years-1,ymin=(X25.),ymax=(X75.), fill=d, group=d),alpha=0.5, colour=NA,show.legend = F) + 
  geom_line(aes(x=years-1,y=(m),colour=d,group=d)) +
  scale_x_continuous(n.breaks = 8)+# = seq(0,to=max(years),by=3)) +
  theme_bw(base_size = 16) + 
  labs(x='Year',y='Billion USD',colour='Capacity reservation, billion doses') +
  theme(legend.position = 'top')
ggsave(capresplot, filename='capresplot.png')



# bpsv. first, discounted. then undiscounted.
for(i in 1:2){
  for(j in 1:NSAMPLES){
    dr = ifelse(i==1,pardf$discount[j],0)
    first0h = time_to_bpsv[j]+1
    bpsv_rd_py[[i]][j,first0h] = bpsv_upfront[j]/(1+dr)^(first0h-1) + inv_cost_per_year[j]/(1+dr)^(first0h-1)
    bpsv_rd_py[[i]][j,(first0h+1):15] = inv_cost_per_year[j]/(1+dr)^c(first0h:14)
  }
}

df = do.call(rbind,lapply(1:2, function(x) data.frame(years,d=c('Discounted','Undiscounted')[x],t(apply(t(apply(bpsv_rd_py[[x]]/1e3,1,cumsum)), 2, function(y)quantile(y,c(1,3)/4))))))

bpplot = ggplot(df)  +
  geom_ribbon(aes(x=years-1,ymin=(X25.),ymax=(X75.), fill=d),alpha=0.5) + 
  scale_x_continuous(n.breaks = 8)+# = seq(0,to=max(years),by=3)) +
  theme_bw(base_size = 16) + 
  labs(x='Year',y='Billion USD',colour='',fill='') +
  theme(legend.position = 'top')
ggsave(bpplot, filename='bpplot.png')



```

```{r}

## bringing together response costs

# R&D

# ssv_rd_plot 
bau_vals = ssv_rd_costsamples[[1]]
ssv_rd_diff = lapply( 2:length(ssv_rd_costsamples), function(x) ( ssv_rd_costsamples[[x]] - bau_vals)/1e3) 
ssv_rd_df = as.data.frame(t(sapply( ssv_rd_diff, function(x) quantile(x,iqrs)) ))
ssv_rd_df$timing = 'Per pandemic'
ssv_rd_df$category = 'R&D'
ssv_rd_df$type = missions

# bpsvresrd
bpsv_rd_res = as.data.frame(t(quantile(bpsvresrd/1e3,iqrs)))
bpsv_rd_res$timing = 'Per pandemic'
bpsv_rd_res$category = 'R&D'
bpsv_rd_res$type = 'BPSV'

# manufacturing

# ssv; take scenarios c(1,3,4) ; already in billions
bau_ref = ssv_proccost_undiscounted[[1]]
ssv_res_diff = lapply(c(3,4), function(x)ssv_proccost_undiscounted[[x]] - bau_ref)
ssv_res_df = as.data.frame(t(sapply(ssv_res_diff, function(x)quantile(x,iqrs))))
ssv_res_df$timing = 'Per pandemic'
ssv_res_df$category = 'Manufacturing'
ssv_res_df$type = capas

# bpsv; in billions

bpsv_proc_res = as.data.frame(t(quantile(bpsvproc/1e3,iqrs)))
bpsv_proc_res$timing = 'Per pandemic'
bpsv_proc_res$category = 'Manufacturing'
bpsv_proc_res$type = 'BPSV'



# delivery
# ssv; in billions
bau_del = ssv_delivery_costs[[1]]
ssv_del_diff = lapply(c(3,4,11),function(x)(ssv_delivery_costs[[x]]-bau_del)/1e3)
ssv_del_df = as.data.frame(t(sapply(ssv_del_diff,function(x)quantile(x,iqrs))))
ssv_del_df$timing = 'Per pandemic'
ssv_del_df$category = 'Delivery'
ssv_del_df$type = c(capas, 'Equality + Delivery')

# bpsv
# quantile(bpsv_del_cost/1e9,iqrs)

bpsv_del = as.data.frame(t(quantile(bpsv_del_cost/1e3,iqrs)))
bpsv_del$timing = 'Per pandemic'
bpsv_del$category = 'Delivery'
bpsv_del$type = 'BPSV'


datares = rbind(ssv_rd_df, bpsv_rd_res, ssv_res_df, bpsv_proc_res, bpsv_del, ssv_del_df)
datares$timing = factor(datares$timing,levels=timings,labels=timings)
datares$type = factor(datares$type,levels=types,labels=types)
# ggplot(datares) + theme_bw(base_size = 15) +
#   geom_hline(yintercept=0,colour='grey') +
#   geom_vline(xintercept=0,colour='grey') +
#   facet_wrap(~timing, scales='free') +
#   geom_bar(aes(x=type,y=`50%`,fill=category),stat = 'identity', position = 'dodge') +
#   geom_errorbar(position = position_dodge(width = 0.9), width=0.6,aes(x=type,group=category,ymin=`25%`,ymax=`75%`),show.legend = F) +
#       theme(axis.text.x = element_text(angle = 60,  hjust=1,vjust=1)) +
#   labs(x='',y='Billion USD',fill='',size='',title='Costs vs. BAU')

datares$category = factor(datares$category,levels=c('R&D','Manufacturing','Delivery'))
unitplot = rbind(prepdata,subset(datares,category!=''))

unitcosts = ggplot(unitplot) + theme_bw(base_size = 15) +
  geom_hline(yintercept=0,colour='grey') +
  geom_vline(xintercept=0,colour='grey') +
  facet_wrap(~timing, scales='free', space = "free_x") +
  geom_bar(aes(x=type,y=`50%`,fill=category),stat = 'identity', position = 'dodge') +
  geom_errorbar(position = position_dodge(width = 0.9), width=0.6,aes(x=type,group=category,ymin=`25%`,ymax=`75%`),show.legend = F) +
      theme(axis.text.x = element_text(angle = 60,  hjust=1,vjust=1)) +
  labs(x='',y='Billion USD',fill='',size='',title='A) Unit Costs vs. BAU') +
  scale_y_continuous(n.breaks = 9) +
  theme(legend.position = 'right')
ggsave(unitcosts + labs(title=''), filename='unit.png',height=5,width=10)


```


```{r}

setDT(unitplot)

unitplot[,`Cost vs. BAU` := paste0('$',format_to_print2(`50%`) ,'$ ($',format_to_print2(`25%`),',',format_to_print2(`75%`),'$)'),by=.(timing,category,type)]

lg = 'Cost differences: investments vs. BAU, for different types of investment.'

setorder(unitplot,timing, category, type)

if (!knitr::is_html_output()) {
  cat(pander(unitplot[,-c(1:3)],caption=lg, missing = ""))
}

```




```{r}
## summing prep costs

# bpsv scenarios
# bpsv_rd_costsamples_dyd billions, discounted
# inv_cost in millions, discounted
# crs in billions
bpsv_ss = as.data.frame(t(quantile(bpsv_rd_costsamples_dyd + inv_cost/1e3 + crs[1] *rawpar$cost_capres*fifteen_yr_discount_weight,iqrs)))
bpsv_ss$Scenario = scennames[2]
bpsv_ss$Category = 'BPSV'
bpsv_ss$Capacity = crs[1]
bpsv_ss$DM = 365


capres_ss = as.data.frame(t(sapply(1:length(crs),function(x) quantile( crs[x] *rawpar$cost_capres*fifteen_yr_discount_weight,iqrs))))
capres_ss$Scenario = scennames[c(1,3:4)]
capres_ss$Category = '365DM'
capres_ss$Capacity = crs
capres_ss$DM = 365

# enabling_costs5 in millions, discounted
dm200_ss = as.data.frame(t(sapply(1:length(crs),function(x) quantile( crs[x] *rawpar$cost_capres*fifteen_yr_discount_weight + enabling_costs_list[[2]]/1e3,iqrs))))
dm200_ss$Scenario = scennames[5:7]
dm200_ss$Category = '200DM'
dm200_ss$Capacity = crs
dm200_ss$DM = 200

# enabling_costs15 in millions, discounted
dm100_ss = as.data.frame(t(sapply(1:length(crs),function(x) quantile( crs[x] *rawpar$cost_capres*fifteen_yr_discount_weight + enabling_costs_list[[3]]/1e3,iqrs))))
dm100_ss$Scenario = scennames[8:10]
dm100_ss$Category = '100DM'
dm100_ss$Capacity = crs
dm100_ss$DM = 100


preps = rbind(bpsv_ss, capres_ss, dm200_ss, dm100_ss)
preps = rbind(preps, capres_ss[1,])
preps$Scenario[11] = scennames[11]
preps$Category[11] = 'Equality + Delivery'
```


```{r}

cost_samples = readRDS('../results/cost_samples.Rds')
cost_diffs = list()
for (i in 1:3){
  cost_diffs[[i]] = cost_samples[[i]]
  for(j in 1:ncol(cost_diffs[[i]]))
    cost_diffs[[i]][,j] = cost_diffs[[i]][,j] - cost_samples[[i]][,1]
}
all_resp_costs <- all_prep_costs <- list()

for(s in 1:length(scennames)){
  all_prep_costs[[s]] = quantile(cost_diffs[[1]][,s]+cost_diffs[[2]][,s]*fifteen_yr_discount_weight,iqrs)/1e3
  all_resp_costs[[s]] = quantile(cost_diffs[[3]][,s]*at_yr_15,iqrs)/1e3
}

preps = as.data.frame(do.call(rbind,all_prep_costs))
preps$Scenario = scennames
preps$Category = c('365 days', 'BPSV', rep('365 days',2),rep(c('200 days','100 days'),each=3), 'Equality + Delivery')
preps$Capacity = crs[scen_capres]
preps$DM = dms[scen_dm]
preps$timing = 'Preparedness'

resps = as.data.frame(do.call(rbind,all_resp_costs))
resps$Scenario = scennames
resps$Category = preps$Category[match(resps$Scenario,preps$Scenario)]
resps$Capacity = crs[scen_capres]
resps$DM = dms[scen_dm]
resps$timing = 'Response'

melted = reshape2::melt(rbind(preps,resps),id.vars=c('Scenario','Category','Capacity','DM','timing'))
# melted$value = melted$value/113.8e3*100
toplot = reshape2::dcast(melted,formula=Scenario+Category+Capacity+DM~timing+variable)

toplot$Category = factor(toplot$Category,levels=c('BPSV', '365 days','200 days','100 days', 'Equality + Delivery'),labels=c('BPSV', '365 days','200 days','100 days', 'Equality + Delivery'))
toplot$Capacity = factor(toplot$Capacity,levels=c(0, 0.7, 2),labels=c('0.5 billion', '1.2 billion','2.5 billion'))

fifcosts = ggplot(toplot) +
  geom_hline(yintercept=0,colour='grey') +
  geom_vline(xintercept=0,colour='grey') +
  geom_abline(linetype=2,slope = -1,intercept = 0,
              colour='navyblue',show.legend = T) +
  geom_segment(
    aes(x = 0, xend = 0, y = 0, yend = 0, linetype = "Break even"),
    inherit.aes = FALSE, alpha = 0, show.legend = TRUE
  ) +
  geom_point(#show.legend = c('colour'=F),
               aes(x=`Preparedness_50%`,y=`Response_50%`,colour=Category,size=Capacity)) +
  geom_text(aes(x=`Preparedness_50%`+.8,y=`Response_50%`+2.5*(1-2*as.numeric(Scenario=='S10')),label=Scenario)) +
  geom_errorbar(show.legend=F,aes(x=`Preparedness_50%`,colour=Category,ymin=`Response_25%`,ymax=`Response_75%`), width = 0) +
  geom_errorbarh(show.legend=F,aes(y=`Response_50%`,colour=Category,xmin=`Preparedness_25%`,xmax=`Preparedness_75%`), width = 0) +
  labs(linetype='',x='Preparedness costs',y='Response costs',colour='',size='Capacity\nreservation',
       title='B) Preparedness vs. response (compared to BAU; billion USD)') +
  scale_linetype_manual(values = c("Break even" = "dashed")) +
  guides(
    linetype = guide_legend(
      override.aes = list(colour = "navyblue",alpha=1),
      title = NULL
    ),
    colour = guide_legend(title = NULL)#,
  ) +
  theme(legend.title = element_text(margin = margin(0,0))) +
  theme_bw(base_size = 15)

final = ggarrange(unitcosts, fifcosts, ncol=1)
ggsave(fifcosts + labs(title=''), filename='fifteen.png',height=6,width=10)

```


# SSV delivery


| Category | Reserved capacity | Private response (existing capacity)  | Private response (built capacity)  |
|---|---|---|---|
| Annual manufacturing volume | By scenario (0.5--2.5B)| 9B minus reserved volume | 6B |
| Facility transition start | 7 weeks before vaccine approval | 7 weeks before vaccine approval | 7 weeks before vaccine approval |
| Weeks to initial manufacturing | 12 | 12 (BPSV) or 30 (no BPSV) | 48 |
| Scale-up weeks to full capacity | 10 | 16 | 16 |

Table: Manufacturing response timeline assumptions 



 

<!-- | Weeks from transition start | 0-11 | 12-21 | 22-29 | 30-45  | 46-47 | 48-63 | 64+ | -->
<!-- |---|---|---|---|---|---|---|---| -->
<!-- | Reserved Capacity (%)  || Scaling from 0-100 | 100 | 100 | 100 | 100 | 100 |  -->
<!-- | Private Capacity (Existing; %)  || | | Scaling from 0-100 | 100 | 100 | 100 |  -->
<!-- | Private Capacity (Response; %)  | | | |  | | Scaling from 0-100 | 100 | -->

 

| Weeks from transition start |	Reserved Capacity (%)	 | Existing Private Capacity (%)	| Response Private Capacity (%) |
|---|---|---|---|
| 0--11 |  |  |  |			
| 12--21 |	Scales from 0 to 100	 |  |  |				
| 22--29 |	100		|   |  |			
| 30--45 |	100 |	Scales from 0 to 100	  |  |
| 46--47 |	100 |	100	  |  |
| 48--63	 |100 |	100 |	Scales from 0 to 100 |
| 64+|	100 |	100 |	100 |

Table: Vaccine Production Timeline when there is no BPSV. When BPSV is also modelled, Existing Private Capacity scales from 0 to 100 in weeks 12--21.


## Timing

Facility transition occurs $I_0=7$ weeks before vaccine approval, which in turn depends on R\&D investments. We have three levels in our scenarios, corresponding to SSVs available in 100 days, 200 days, and 365 days. The total weeks taken for vaccine approval can be written as follows:


```{r}
eqtext = 'W_{j}^{(S)} = \\sum_{i=0}^3 W_{i;j}^{(S)}'
printmath(eqtext)
```

for $j\in\lbrace 365, 200, 100\rbrace$. These work out as `r time_to_approval[1]`, `r time_to_approval[2]`, and `r time_to_approval[3]` weeks, respectively. Thus "week 0" for manufacturing occurs `r time_to_approval[1]-7`, `r time_to_approval[2]-7`, and `r time_to_approval[3]-7` weeks, respectively, after the new pathogen has been sequenced. We denote this variable $w_s^{(0)}$.




## Production

The total global manufacturing volume is $M_G=15$ billion doses. The amount that is reserved, in billion doses, including the HIC-specific reservation of $A_3=0.5$ billion doses, depends on the scenarios as follows:

```{r}
eqtext = 'M_{R,s} = \\left\\{\\begin{array}{lr}A_3 & s\\in\\{0, 1, 4, 7, 10\\} \\\\ 
A_3 + 0.7 & s\\in\\{2, 5, 8\\} \\\\ 
A_3 + 2 & s\\in\\{3, 6, 9\\} \\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

where $s=0$ denotes the BAU scenario. By definition, $M_{E,s} = M_C - M_{R,s}$, and $M_B=M_G-M_C$.

Then the number of doses, in billions, that are made from capacity $x\in \lbrace R, E, B\rbrace$ in week $w$ of scenario $s$ is:


```{r}
eqtext = 'Z_{x,s,w} = \\left\\{\\begin{array}{lr}0 & w-w_s^{(0)} \\leq I_x \\\\ 
\\frac{1}{52}\\frac{w-w_s^{(0)}-I_x}{C_x}M_{x,s} & w-w_s^{(0)}\\in(I_x, I_x+C_x] \\\\ 
\\frac{1}{52}M_{x,s}  & w-w_s^{(0)}> I_x+C_x
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

<!-- \frac{1}{52}M_{R,s}  & w\in[I_R+C_R, I_E)\\\\  -->
<!-- \frac{1}{52}\left(M_{R,s} + \frac{w-I_E+1}{C_E}M_{E,s}\right) & w\in[I_E, I_E+C_E)\\\\  -->
<!-- \frac{1}{52}\left(M_{R,s} + M_{E,s}\right)  & w\in[I_E+C_E, I_B)\\\\  -->
<!-- \frac{1}{52}\left(M_{R,s} + M_{E,s} + \frac{w-I_B+1}{C_B}M_{B}\right) & w\in[I_B, I_B+C_B)\\\\  -->

where $I_R = `r rawpar$weeks_init_res`$ is the number of weeks to initial manufacturing for reserved capacity, $C_R = `r rawpar$weeks_scale_res`$ is the number of weeks to scale up to full capacity; $I_B = `r rawpar$weeks_init_bui`$ is the number of weeks to initial manufacturing for built and unreserved capacity, $C_B = `r rawpar$weeks_scale_bui`$ is the number of weeks to scale up to full capacity, and

```{r}
eqtext = 'I_E = \\left\\{\\begin{array}{lr}
 I_{E,1} \\; & \\; s=1 \\\\
I_{E,0}  \\; & \\; s\\neq 1
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

where $I_{E,0} = `r rawpar$weeks_init_ex_nb`$ and $I_{E,1} = `r rawpar$weeks_init_ex_bp`$ are the number of weeks to initial manufacturing for existing and unreserved capacity, $C_E = `r rawpar$weeks_scale_ex`$ is the number of weeks to scale up to full capacity.







```{r supply, fig.cap='Doses made available from manufacturing per scenario. Weeks are in reference to the sequencing of the pathogen.'}

t_supply <- as.data.frame(do.call(rbind,lapply(1:length(scennames),function(x)cbind(scen=scennames[x],doses=cumulative[[x]],week=1:NWEEKS))))

names(cumulative) = scennames

scens = setDT(data.frame(scen=scennames, capres = scen_capres, dm = scen_dm, bpsv = as.numeric(bpsv_scen)))
scens[,comb := paste0(capres,dm,bpsv)]
scens[,N:=.N,by=comb]
sames <- list()
for(un in unique(scens$comb)){
  subscen = subset(scens,comb==un)
  if(nrow(subscen)>1)
    sames[[length(sames)+1]] <- subscen$scen
}

ggplot(t_supply) + 
  geom_line(aes(x=as.numeric(week),y=as.numeric(doses),colour=factor(scen,levels=scennames))) +
  theme_bw(base_size = 15) +
  labs(x='Week',y='Cumulative doses manufactured, billions',colour='Scenario')
# ggplot(subset(t_supply,scen%in%scennames[2])) + 
#   geom_line(aes(x=as.numeric(week),y=as.numeric(doses),colour=factor(scen,levels=scennames))) +
#   theme_bw(base_size = 15) +
#   labs(x='Week',y='Cumulative doses manufactured, billions',colour='Scenario') +
#   scale_x_continuous(limits= c(55,65)) + 
#   scale_y_continuous(limits=c(0,1/2))
```

In Figure \@ref(fig:supply), the following scenarios have identical supply (because they have the same capacity reservations and R\&D investments): `r paste0(sames[[1]],collapse=' & ')`.

## Allocation

Denote the weekly allocated doses at week $w$ from capacity $x$ to income level $i$ $k_{s,x,i,w}$, and the cumulative number $K_{s,i,w}$, such that 


```{r}
eqtext = 'K_{s,i,w} = \\sum_{x\\in\\lbrace R,E,B\\rbrace}\\sum_{j=0}^w k_{s,x,i,j}.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```




<!-- assuming vaccine wastage of $\delta = `r round(rawpar$vaccine_wastage,2)`$. -->

```{r}
eqtext = 'k_{s,R,i,w} = \\left\\{ \\begin{array}{lr}
\\frac{A_3}{M_{R,s}}Z_{R,s,w}             & K_{s,\\text{HIC},w} <  L_{\\text{HIC}}\\;\\&\\; i=\\text{HIC} \\\\
\\frac{M_{R,s}-A_3}{M_{R,s}}\\frac{N_{i}}{N_{HIC}+N_{UMIC}+N_{LMIC}+N_{LIC}}Z_{R,s,w}                    & K_{s,\\text{HIC},w} < L_{\\text{HIC}}  \\\\
0 & K_{s,\\text{HIC},w} \\geq L_{\\text{HIC}} \\;\\&\\; i=\\text{HIC}\\\\
\\frac{N_{i}}{N_{UMIC}+N_{LMIC}+N_{LIC}}Z_{R,s,w} & K_{s,\\text{HIC},w} \\geq L_{\\text{HIC}} \\;\\&\\;  K_{s,\\text{UMIC},w} < L_{\\text{UMIC}} \\;\\&\\; i\\neq\\text{HIC}\\\\
0 & K_{s,\\text{UMIC},w} \\geq L_{\\text{UMIC}} \\;\\&\\; i=\\text{UMIC}\\\\
\\frac{N_{i}}{N_{LMIC}+N_{LIC}}Z_{R,s,w} & K_{s,\\text{UMIC},w} \\geq L_{\\text{UMIC}} \\;\\&\\;  K_{s,\\text{LMIC},w} < L_{\\text{LMIC}} \\;\\&\\; i\\notin  \\lbrace\\text{HIC},\\text{UMIC}\\rbrace\\\\
0 & K_{s,\\text{LMIC},w} \\geq L_{\\text{LMIC}} \\;\\&\\; i=\\text{LMIC}\\\\
Z_{R,s,w}             & K_{s,\\text{LMIC},w} \\geq L_{\\text{LMIC}} \\;\\&\\; K_{s,\\text{LIC},w} < L_{\\text{LIC}} \\;\\&\\; i=\\text{LIC}\\\\
0 & K_{s,\\text{LIC},w} \\geq L_{\\text{LIC}} 
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```


The logic of this reads as follows:

- $A_3=0.5$ billion doses per year from reserved capacity go exclusively to HIC, which is expressed as a fraction of the total reservation, $M_{R,s}$
- Any remaining reserved capacity doses are allocated according to population
- Once HIC reach their total demand, doses from reserved capacity are split proportional to population between UMIC, LMIC and LIC, and so on




For $x\in\lbrace E,B\rbrace$,


```{r}
eqtext = 'k_{s,x,i,w} = \\left\\{ \\begin{array}{lr}
Z_{x,s,w}            & K_{s,\\text{HIC},w} < L_{\\text{HIC}} \\;\\&\\; i=\\text{HIC} \\\\
0                     & K_{s,\\text{HIC},w} < L_{\\text{HIC}} \\;\\&\\; i\\neq\\text{HIC} \\\\
Z_{x,s,w}            & K_{s,\\text{HIC},w} \\geq L_{\\text{HIC}} \\;\\&\\; K_{s,\\text{UMIC},w} < L_{\\text{UMIC}} \\;\\&\\; i=\\text{UMIC} \\\\
0                     & K_{s,\\text{HIC},w} \\geq L_{\\text{HIC}} \\;\\&\\; K_{s,\\text{UMIC},w} < L_{\\text{UMIC}} \\;\\&\\; i\\neq\\text{UMIC} \\\\
Z_{x,s,w}            & K_{s,\\text{UMIC},w} \\geq L_{\\text{UMIC}} \\;\\&\\; K_{s,\\text{LMIC},w} < L_{\\text{LMIC}} \\;\\&\\; i=\\text{LMIC} \\\\
0                     & K_{s,\\text{UMIC},w} \\geq L_{\\text{UMIC}} \\;\\&\\; K_{s,\\text{LMIC},w} < L_{\\text{LMIC}} \\;\\&\\; i\\neq\\text{LMIC} \\\\
Z_{x,s,w}            & K_{s,\\text{LMIC},w} \\geq L_{\\text{LMIC}} \\;\\&\\; i=\\text{LIC} \\\\
0                     & K_{s,\\text{LMIC},w} \\geq L_{\\text{LMIC}} \\;\\&\\; i\\neq\\text{LIC} 
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

The logic of this reads as follows:

- Until HIC demand is reached, all doses from unreserved capacity go to HIC. None go to UMIC, LMIC and LIC.
- Once HIC demand has been met and until UMIC demand is reached, all doses from unreserved capacity go to UMIC. None go to HIC, LMIC and LIC.
- Once HIC and UMIC demand have been met and until LMIC demand is reached, all doses from unreserved capacity go to LMIC. None go to HIC, UMIC and LIC.
- Once HIC, UMIC and LMIC demand have been met, all remaining doses from unreserved capacity go to LIC. None go to LMIC, UMIC and HIC.



Total supply of first-schedule doses in each year period is 


```{r}
eqtext = 'A_{x,s,y}^{(1)} = \\sum_i\\sum_{w\\in y}k_{s,x,i,w}.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

We assume, for every second dose of SSV, a booster will be given one year later for $N^{\text{(boost)}} = `r rawpar$n_boosters`$ years.

Thus 

```{r}
eqtext = 'A_{s,y}^{(2)} = \\left\\{ \\begin{array}{lr}
\\frac{1}{2}\\sum_{x}A_{x,s,y-1}^{(1)}            & y=2 \\\\
\\frac{1}{2}\\sum_{x}\\left(A_{x,s,y-1}^{(1)} + A_{x,s,y-2}^{(1)}\\right)            & y>2 
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

and

```{r}
eqtext = 'A_{x,s,y}^{(2)} = \\min(A_{s,y}^{(2)}, M_R - A_{R,s,y}^{(1)})'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

for $x=R$ and

```{r}
eqtext = 'A_{x,s,y}^{(2)} = \\max(A_{s,y}^{(2)} - A_{R,s,y}^{(2)}, 0)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

for $x\in\lbrace E, B \rbrace$.

Then

```{r}
eqtext = 'A_{x,s,y} = A_{x,s,y}^{(1)} + A_{x,s,y}^{(2)}.
(\\#eq:supply)'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```



```{r procurement,fig.cap='Doses procured by country income level'}

ggplot(reshape2::melt(do.call(rbind,alloc),id.vars=c('Scenario','Week'))) +
  geom_line(aes(x=Week,colour=Scenario,y=value)) +
  facet_wrap(~variable) +
  theme_bw(base_size = 15) +
  labs(x='Week',y='Cumulative doses procured, billions',colour='Scenario')

```

## Delivery

**These values do not look correct**


Delivery is written as $h_{s,i,w}^{(j)}$ doses delivered in scenario $s$, income group $i$ and week $w$ for schedule $j$, which is $j=1$ for first-dose SSV, $j=2$ for second-dose SSV, and $j=2+k$ for $k=\lbrace 1,...,N^{(boost)}\rbrace$.

The second dose is prioritised over the first, and follows the first by four weeks, so 

```{r}
eqtext = 'h_{s,i,w}^{(2)} = h_{s,i,w-4}^{(1)}.'
printmath(eqtext)
```



```{r}
eqtext = 'h_{s,i,w}^{(2)} = h_{s,i,w-4}^{(1)}.'
printmath(eqtext)
```




Available doses are $K_{s,i,w}$, 

the cumulative doses allocated to income group $i$ by week $w$, minus doses given so far. 

First doses stop being given once $L_i/2$ is reached.

```{r}
eqtext = 'h_{s,i,w}^{(1)} = ( 0 )'
if (knitr::is_html_output()) {
  cat(paste0("```math\n",eqtext,"\n```",collapse=''))
} else {
  cat(paste0("$$\n",eqtext,"\n$$",collapse=''))
}
```

```{r,eval=F}
eqtext <- 'h_{s,i,w}^{(1)} =
\\max\\left\\lbrace 0
\\right\\rbrace'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```

```{r}
# eqtext <- r"( h_{s,i,w}^{(1)} =
# \max\Bigl\lbrace 0,\,
# \min\Bigl\lbrace
# K_{s,i,w} - h_{s,i,w}^{(2)} - \sum_{j=1}^2 \sum_{k=1}^{w-1} h_{s,i,k}^{(j)},\,
# L_i/2 - \sum_{k=1}^{w-1} h_{s,i,k}^{(1)}
# \Bigr\rbrace
# \Bigr\rbrace )"
# cat(paste0("$$\n", eqtext, "\n$$\n"))


# eqtext <- 'h_{s,i,w}^{(1)} =
# \\max\\left\\lbrace 0,
# \\min\\left\\lbrace  K_{s,i,w} - h_{s,i,w}^{(2)} - \\sum_{j=1}^2 \\sum_{k=1}^{w-1} h_{s,i,k}^{(j)},
# L_i/2 - \\sum_{k=1}^{w-1} h_{s,i,k}^{(1)}
# \\right\\rbrace
# \\right\\rbrace'
# cat(paste0("$$\n", eqtext, "\n$$\n"))

```


```{r scendelivery,fig.cap='Cumulative vaccine coverage (second SSV dose) by country income level'}


second_dose_delivery = lapply(1:length(second_dose_delivery),function(x)cbind(second_dose_delivery[[x]],Scenario=scennames[x]))
ggplot(do.call(rbind,second_dose_delivery)) +
  geom_line(aes(x=Week*7,colour=Scenario,y=doses*100)) +
  facet_wrap(~factor(il,levels=INCOMELEVELS)) +
  theme_bw(base_size = 15) +
  scale_x_continuous(limits=c(0,1300)) +
  labs(x='Day',y='Second-dose coverage, percent population',colour='Scenario')


```



# BPSV delivery

## Timing

The duration of the Phase III trial is $W_3^{(B)} = `r rawpar$duration_3_res`$ weeks. The time to manufacturing transition is $I_R = `r rawpar$weeks_init_res`$ weeks, and the time to manufacturing scale-up $C_R = `r rawpar$weeks_scale_res`$ weeks; these are the same as the reserved-capacity times for SSV. 


Facility transition occurs in week 1. Thus manufacturing begins in week $1+I_R = `r 1+rawpar$weeks_init_res`$ and dose distribution begins in week $1+W_3^{(B)} = `r 1+rawpar$duration_3_res`$.

## Production

The number of doses, in billions, that are made in week $w$ is:


```{r}
eqtext = 'Z_{w} = \\left\\{\\begin{array}{lr}0 & w < I_R \\\\ 
\\frac{1}{52}\\frac{w-I_x+1}{C_x}M_{x,s} & w\\in[I_R, I_R+C_R) \\\\ 
\\frac{1}{52}M_{x,s}  & w-1\\geq I_R+C_xR
\\end{array}\\right.'
if (knitr::is_html_output()) {
  cat(paste0("\\begin{equation}\n",gsub("\\\\(?!([a-z]|#))", "\\\\\\\\", eqtext, perl = TRUE),"\n\\end{equation}\n",collapse=''))
} else {
  cat(paste0("\\begin{equation}\n",eqtext,"\\end{equation}\n",collapse=''))
}
```




```{r bpsvsupply, fig.cap='BPSV doses made available from manufacturing per scenario. Weeks are in reference to the sequencing of the pathogen.'}

ggplot(b_supply) + 
  geom_line(aes(x=as.numeric(week),y=as.numeric(doses))) +
  theme_bw(base_size = 15) +
  labs(x='Week',y='Cumulative doses manufactured, billions',colour='Scenario')

```


## Allocation

Doses are all allocated in proportion to the eligible population.




```{r bpsvprocurement,fig.cap='BPSV doses procured by country income level'}

ggplot(reshape2::melt(b_alloc,id.vars=c('Week'))) +
  geom_line(aes(x=Week,colour=variable,y=value)) +
  theme_bw(base_size = 15) +
  labs(x='Week',y='Cumulative doses procured, billions',colour='Income level')

```

## Delivery

**These values do not look correct**


```{r bpsvdeliveryplot,fig.cap='BPSV vaccine coverage by country income level'}

ggplot(reshape2::melt(bpsv_dose_delivery,id.vars=c('Week'))) +
  geom_line(aes(x=Week*7,colour=factor(variable,levels=INCOMELEVELS,labels=INCOMELEVELS),y=value*100)) +
  theme_bw(base_size = 15) +
  labs(x='Day',y='BPSV coverage, percent population',colour='Income level')


```



# Parameter samples

```{r parsamples}

for(i in 1:length(params))
  base::print(
    ggplot() + 
      geom_histogram(aes(x=params[[i]])) + 
      theme_bw(base_size = 13) + 
      labs(x='',y='',title=names(params)[i])
    )

```


# Contributors

Model: Peter Windus, Andy Torkelson

Data: Peter Windus, Andy Torkelson, Damian Walker

Documentation: Peter Windus, Andy Torkelson, Rob Johnson

R code: Rob Johnson


# References
